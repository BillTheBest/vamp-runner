---
kind: breed
name: traffic
deployable:
  type: application/javascript
  definition: |
    'use strict';

    var http = require('request');
    var vamp = require('vamp-node-client');
    var api = new vamp.Api();

    var vga;
    var count = 0;

    var run = function() {
      if (!vga) {
        api.config(function (config) {
          vga = config['vamp.gateway-driver.host'];
        });
      } else {
        count++;
        http('http://' + vga + ':' + process.env.PORT, function (error, response, body) {
           if (!error)
             if (count % 20 == 0) api.event(['workflows:traffic', 'response:ok'], count);
           else
             api.event(['workflows:traffic', 'response:error'], error);
        });
      }
    };

    setInterval(run, 500);

---
kind: workflow
name: traffic
breed: traffic
schedule: daemon
environment_variables:
  PORT : 9050