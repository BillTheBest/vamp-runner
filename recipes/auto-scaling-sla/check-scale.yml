---
kind: breed
name: check-scale
deployable:
  type: application/javascript
  definition: |
    'use strict';

    var vamp = require('vamp-node-client');
    var _ = require('highland');
    var request = require('request-promise');

    var http = request.defaults({
      headers: {'Accept': 'application/json', 'Content-Type': 'application/json'}
    });

    var api = new vamp.Api();

    var period = 5;

    var process = function() {
      http({
        url: api.url + 'deployments/sava/clusters/sava/services/runner/scale'
      }).promise().then(function (response) {
        if (response) {
          var scale = JSON.parse(response);
          api.event(['workflows:check-scale', 'scale'], scale.instances);
          if (scale.instances != 1) api.event(['workflows:check-scale', 'response:ok'], 'ok');
        }
      });
    };

    process();
    setInterval(process, period * 1000);

---
kind: workflow
name: check-scale
breed: check-scale
schedule: daemon